import { describe, it, expect, vi, beforeEach } from 'vitest'
import { createServer, startServer } from '../../src/core/server.js'
import type { MockflyConfig } from '../../src/utility-types'

// Mock dependencies
vi.mock('fastify', () => {
  const mockRegister = vi.fn()
  const mockListen = vi.fn()
  
  return {
    default: vi.fn(() => ({
      register: mockRegister,
      listen: mockListen,
      close: vi.fn().mockResolvedValue(undefined),
      get: vi.fn(),
      post: vi.fn(),
      put: vi.fn(),
      delete: vi.fn(),
      patch: vi.fn(),
      options: vi.fn(),
      head: vi.fn()
    }))
  }
})

vi.mock('@fastify/cors', () => ({
  default: vi.fn()
}))

vi.mock('@fastify/static', () => ({
  default: vi.fn()
}))

vi.mock('../../src/core/routes.js', () => ({
  registerRoutes: vi.fn().mockResolvedValue(undefined)
}))

vi.mock('../../src/core/errors.js', () => ({
  createError: vi.fn((code, message, details) => {
    const error = new Error(message)
    ;(error as any).code = code
    ;(error as any).details = details
    return error
  }),
  ErrorCodes: {
    SERVER_START_FAILED: 'SERVER_START_FAILED'
  },
  logInfo: vi.fn()
}))

describe('server', () => {
  const baseConfig: MockflyConfig = {
    port: 4000,
    host: 'localhost',
    baseUrl: '/api',
    delay: 0,
    cors: true,
    mockDir: './mockfly/data',
    routes: []
  }

  beforeEach(() => {
    vi.clearAllMocks()
  })

  describe('createServer', () => {
    it('should create Fastify instance with logger disabled', async () => {
      const Fastify = await import('fastify')
      await createServer(baseConfig)

      expect(Fastify.default).toHaveBeenCalledWith({
        logger: false
      })
    })

    it('should register routes', async () => {
      const { registerRoutes } = await import('../../src/core/routes.js')
      await createServer(baseConfig)

      expect(registerRoutes).toHaveBeenCalled()
    })
  })

  describe('startServer', () => {
    it('should log server info on successful start', async () => {
      const Fastify = await import('fastify')
      const mockFastify = Fastify.default()
      mockFastify.listen = vi.fn().mockResolvedValue(undefined)
      
      const { logInfo } = await import('../../src/core/errors.js')
      
      await startServer(baseConfig)

      expect(logInfo).toHaveBeenCalledWith('MockFly server running at http://localhost:4000')
      expect(logInfo).toHaveBeenCalledWith('Base URL: /api')
      expect(logInfo).toHaveBeenCalledWith('Health check: http://localhost:4000/health')
    })

    it('should throw error when server fails to start', async () => {
      const Fastify = await import('fastify')
      const mockFastify = Fastify.default()
      mockFastify.listen = vi.fn().mockRejectedValue(new Error('Port already in use'))

      const { createError } = await import('../../src/core/errors.js')
      
      await expect(startServer(baseConfig)).rejects.toThrow('Failed to start server on localhost:4000')
      
      expect(createError).toHaveBeenCalledWith(
        'SERVER_START_FAILED',
        'Failed to start server on localhost:4000',
        expect.objectContaining({
          host: 'localhost',
          port: 4000
        })
      )
    })
  })
})